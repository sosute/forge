# AI駆動型テスト駆動開発（TDD）統合ガイドライン

このドキュメントは、t-wada氏のTDD哲学に基づき、AI（Claude Code）を活用した効率的なテスト駆動開発のための包括的なガイドラインです。

## 1. 基本哲学：テストが開発を駆動する

### 核となる原則
- **テストファースト:** すべてのプロダクションコードは、失敗するテストをパスさせるためだけに書かれる
- **テストは仕様書:** テストは後付けの作業ではなく、それ自身が仕様書であり設計の駆動役
- **リファクタリングへの自信:** 包括的なテストスイートがセーフティネットとなり、恐れることなく継続的な改善が可能
- **テスト容易性 = 良い設計:** テストしにくいコードは悪い設計の兆候。テスト容易性は疎結合で凝集度の高いアーキテクチャに繋がる

### Ping-Pong Programming方式
- AIはテストコードを書く役割と実装する役割を分離
- 役割の明確な分離により、より良い設計と実装を実現

## 2. 開発サイクル：レッド・グリーン・リファクタリング・コミット

### フェーズ1：レッド - 失敗するテストを書く
**目的:** これから何を達成するのかを明確に定義する

**実施内容:**
- 実装したい単一の機能に対する、具体的で失敗するテストを一つ作成
- もっともシンプルなテストケースから始め、段階的に複雑なテストケースを追加
- 対応する実装がまだ存在しないため、このテストは必ず失敗（レッド）する

**制約:**
- AI（テスト作成者）は、テストコード以外のコードは絶対に書いてはいけない
- 一度に一つのテストケースのみを作成

### フェーズ2：グリーン - テストをパスさせる
**目的:** テストで示された要件を満たす

**実施内容:**
- 失敗したテストをパスさせるために必要な最小限のコードを記述
- 指定されたテストケースがパスするだけでなく、既存のテストケースもすべてパスするように実装

**制約:**
- この段階で余分な機能を追加しない
- コードの美しさは追求せず、ただテストをパス（グリーン）させることだけを考える
- テストコード自体を修正したり、削除したりすることは禁止

### フェーズ3：リファクタリング - 設計を改善する
**目的:** テストが通っている状態を維持しながら、コードの品質を向上させる

**実施内容:**
- 重複の排除（DRY原則）
- 命名の明確化
- 複雑なロジックの単純化
- コーディング規約の遵守確認
- 可読性と保守性の向上

**制約:**
- リファクタリング全プロセスを通じて、すべてのテストはグリーンの状態を維持

### フェーズ4：コミット - 進捗を保存する
**目的:** 正常に動作する小さな機能単位を、安全なバージョンとして記録する

**実施内容:**
- 全テストがグリーンであることを最終確認
- `git add .` を実行して変更をステージング
- 意味のあるコミットメッセージを作成

## 3. AI活用によるPing-Pong実装方式

### テスト作成AI（あなた）の役割
1. 失敗するテストコードを作成
2. 実装者（別のAI）への指示を作成
3. 実装結果の確認と評価
4. 必要に応じてリファクタリングを依頼

### 実装AI（Claude Code非対話モード）への指示

#### コマンドフォーマット
```bash
# 初回実行
claude -p "指示" --output-format=json --system-prompt "システムプロンプト" --allowedTools "許可されたツール"

# セッション再開（2回目以降）
claude -p "指示" --output-format=json --resume <session_id> --system-prompt "システムプロンプト" --allowedTools "許可されたツール"
```

#### システムプロンプト
```
- t-wadaさんのやり方に従う
- あなたは Ping-Pong Programming における、失敗するテストコードをパスするコードを書く役割を担う
- テストコード自体を修正したり、削除したりすることは禁止する
- テストコードの修正が必要な場合は、ユーザーへ知らせること
- 指定されたテストケースがパスするだけでなく、既存のテストケースもすべてパスするように実装すること
- 作業を遂行する上で権限が不足している場合は、ユーザーへ何の権限が不足しているかを伝えること
```

#### 許可されたツール
```
Read
ReadFile
Edit
MultiEdit
WriteFile
DeleteFile
Grep
LS
Glob
Bash(npm run:*)
Bash(npm test)
Bash(cat:*)
Bash(ls:*)
Bash(tree:*)
Bash(find:*)
Bash(mkdir:*)
```

### 指示内容
- タスクの目的
- 失敗するテストコードの情報（プロジェクトルートからの相対パス、テストケース名）

### 結果確認プロセス
1. 実装者からの出力結果を確認し、テストコードが成功するかチェック
2. テストが失敗する場合は再度実装者に指示を出す
3. 権限不足の場合、ユーザーに不足している権限情報を伝えて処理を中断
4. テストコードが成功する場合、コードを評価し、可読性や保守性に問題があればリファクタリングを依頼

## 4. 厳格なコーディング規約

### 【最重要】ハードコードの絶対禁止

#### マジックナンバー
- **悪い例:** `if (age > 20)`
- **良い例:** `const ADULT_AGE = 20; if (age > ADULT_AGE)`

#### 設定値
- APIキー、URL、ファイルパスは設定ファイル（`.env`など）や環境変数から読み込む
- ソースコード内に直接記述しない

#### ユーザー向け文字列
- UIテキスト、ログ、エラーメッセージは定数や言語ファイルで管理
- メンテナンスと国際化を容易にする

### その他の主要な規約
- **単一責任の原則 (SRP):** 一つのモジュール、クラス、関数は一つの責任のみを持つ
- **DRY (Don't Repeat Yourself):** コードの重複は絶対に避ける
- **明確で意図の伝わる命名:** 変数名や関数名は目的と意図が明確に伝わるように
- **ガード節 / 早期リターン:** 深くネストした`if-else`構造を避ける
- **セキュリティ第一:** ユーザー入力は常に信頼せず、サニタイズとエンコードを徹底

## 5. 使用技術
- Node.js
- Jest（テストフレームワーク）
- TypeScript

## 6. ワークフローのベストプラクティス

### テストケースの段階的追加
1. 最もシンプルなケースから開始
2. 境界値テスト
3. エラーケース
4. 複雑な統合シナリオ

### セキュリティ考慮事項
- XSS、SQLインジェクション等の一般的な脆弱性を防ぐ
- 入力のサニタイズと出力のエンコードを徹底
- ユーザーからの入力は常に信頼しない

### 権限管理
- AIには必要最小限の権限のみを付与
- 権限不足時は勝手な判断で進めず、ユーザーに確認

## 7. 注意事項

**重要:** コマンドを実行する前に、必ず必要なオプションが正しく指定されていることを確認すること。特に：
- `--system-prompt` の内容が正確であること
- `--allowedTools` に必要なツールがすべて含まれていること
- 初回実行とセッション再開の使い分けが適切であること

このガイドラインに従うことで、高品質で保守性の高いコードを、効率的かつ安全に開発することができます。