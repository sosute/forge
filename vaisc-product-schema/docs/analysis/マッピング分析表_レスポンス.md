# VAISC レスポンスマッピング分析表

## 📋 分析概要

**目的**: 既存search/menu APIレスポンス構造をVAISC統合エンドポイントで再現する際のフィールド対応関係の精査  
**根拠**: VAISCから既存APIレスポンス形式への変換における互換性確保とフィールドマッピングの明確化

## 🔍 Search APIレスポンスマッピング

### 商品基本情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `productId` | 商品識別子 | `s_product_id` | `"CF0212351201"` | `product.id` | `"CF0210888001"` |  |
| `detailUrl` | 商品詳細URL | `url` | `"https://voi.0101.co.jp/..."` | `product.uri` | `"https://voi.0101.co.jp/voi/webcatalog/..."` |  |
| `productName1` | 商品名 | `n_product_name_1` | `"ニットTシャツ"` | `product.title` | `"adidas"` |  |
| `productName2` | ブランド名 | `n_product_name_2` | `"アイテムズ アーバンリサーチ"` | `product.brands[0]` | `"adidas"` |  |
| `imageURL` | 商品画像URL | `s_thumb_img` | `"https://image.0101.co.jp/..."` | `product.images[0].uri` | `"https://image.0101.co.jp/28936/..."` |  |
| `scdName` | カテゴリ名 | `t_item_code_text` | `"ニット・セーター"` | `product.categories[-1]` | `"スニーカー"` |  |

### ブランド情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `brandTextJP` | ブランド名（日本語） | `s_web_brand_code_text_jp` | `"アイテムズ アーバンリサーチ"` | `product.brands[0]` | `"adidas"` |  |
| `brandTextEN` | ブランド名（英語） | `s_web_brand_code_text_en` | `"ITEMS URBAN RESEARCH"` | `product.attributes.brand_name_en.text[0]` | `"adidas"` |  |
| ブランドコード（内部使用） | ブランドコード | `s_web_brand_code` | `"30095"` | `product.attributes.brand_code.text[0]` | `"30001"` |  |

### 価格情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `taxInclusivePrice` | 税込価格 | `i_tax_inclusive_price` | `4990` | `product.priceInfo.price` | `7150` |  |
| `oldPrice` | 定価 | `i_old_price` | `5490` | `product.priceInfo.originalPrice` | `7150` |  |
| `discountRate` | 割引率 | `i_discount_rate` | `9` | `product.attributes.discount_rate.numbers[0]` | `0` |  |

### ユーザー評価情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `commentCount` | コメント数 | `i_comment_count` | `2` | `product.attributes.comment_count.numbers[0]` | `5` |  |
| `evaluationAverage` | 平均評価値 | `f_evaluation_average` | `4.5` | `product.attributes.evaluation_average.numbers[0]` | `4.8` |  |
| `favoriteCount` | お気に入り数 | `i_favorite_count` | `2` | `product.attributes.favorite_count.numbers[0]` | `3` |  |

### 商品フラグレスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `flags.pricereduced` | 値下げフラグ | `i_icon_flag_pricereduced` | `1` | `product.attributes.flag_pricereduced.text[0] === "true"` | `"false"` |  |
| `flags.sale` | セールフラグ | `i_icon_flag_sale` | `0` | `product.attributes.flag_sale.text[0] === "true"` | `"true"` |  |
| `flags.newarrival` | 新着フラグ | `i_icon_flag_newarrival` | `1` | `product.attributes.flag_newarrival.text[0] === "true"` | `"true"` |  |
| `flags.rearrival` | 再入荷フラグ | `i_icon_flag_rearrival` | `0` | `product.attributes.flag_rearrival.text[0] === "true"` | `"false"` |  |
| `flags.giftwrap` | ギフト可フラグ | `i_icon_flag_giftwrap` | `0` | `product.attributes.flag_giftwrap.text[0] === "true"` | `"false"` |  |
| `flags.limitedsale` | 期間限定フラグ | `i_icon_flag_limitedsale` | `0` | `product.attributes.flag_limitedsale.text[0] === "true"` | `"false"` |  |
| `flags.salespromotion` | 販促フラグ | `i_icon_flag_salespromotion` | `0` | `product.attributes.flag_salespromotion.text[0] === "true"` | `"false"` |  |
| `flags.deliveryfeeoff` | 送料無料フラグ | `i_icon_flag_deliveryfeeoff` | `0` | `product.attributes.flag_deliveryfeeoff.text[0] === "true"` | `"false"` |  |
| `flags.secretsale` | シークレットセール | `i_icon_flag_secretsell` | `0` | `product.attributes.flag_secretsale.text[0] === "true"` | `"false"` |  |
| `flags.reservation` | 予約可フラグ | `i_icon_flag_reservation` | `0` | `product.attributes.flag_reservation.text[0] === "true"` | `"false"` |  |
| `flags.used` | 中古フラグ | `i_icon_flag_used` | `0` | `product.attributes.flag_used.text[0] === "true"` | `"false"` |  |
| `flags.coupon` | クーポン対象フラグ | `i_icon_flag_coupon` | `0` | `product.attributes.flag_coupon.text[0] === "true"` | `"true"` |  |
| `flags.bulkdiscount` | まとめ割フラグ | `i_icon_flag_bulk_discount` | `1` | `product.attributes.flag_bulkdiscount.text[0] === "true"` | `"false"` |  |
| `flags.pricerereduced` | 再値下げフラグ | ❌ DBフィールド不明 | ❌ | ❌ | ❌ | 未対応 |

### 特別機能レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `bulkDiscountMessage` | まとめ割メッセージ | `i_bulk_discount_apply_low_lm_goods_qty` + `i_bulk_discount_rate` | `"2個以上で10%OFF"` | 複数属性からメッセージ生成 | `attributes.bulk_discount_min_qty: 2, attributes.bulk_discount_rate: 10` |  |
| `couponThumbnail` | クーポンサムネイル | ❌ DBフィールドなし | ❌ | ❌ | ❌ | 未対応 |

### カラー表示機能レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `colorProducts` (代表色) | 代表色表示 | `sm_color_id` + `sm_color_search` | `{"colorId": "brown", "colorName": "ブラウン"}` | `product.colorInfo.colors[0]` + ID情報 | `colors: ["ホワイト"], attributes.color_id: ["white"]` |  |
| `colorProducts` (全色) | 全色表示 | `sm_color_id` + `sm_color_search` | `[{"colorId": "brown"}, {"colorId": "white"}]` | `product.colorInfo.colors[]` 全配列 + ID配列 | `colors: ["ホワイト", "ブラック"], attributes.color_id: ["white", "black"]` |  |

### ページング・メタ情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `nowPage` | 現在のページ番号 | ❌ VAISC計算 | `1` | `response.pagination.currentPage` | `1` |  |
| `per` | 1ページあたりの件数 | ❌ VAISC計算 | `20` | `response.pagination.pageSize` | `20` |  |
| `total` | 総商品数 | ❌ VAISC計算 | `847` | `response.totalProductCount` | `1411` |  |

### 最上位レスポンス構造

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `redirectURL` | リダイレクトURL | ❌ リダイレクト処理 | `null` | アプリケーションロジック | `null` |  |
| `searchContent.naviTreeTitle` | ナビゲーションタイトル | ❌ 固定値 | `"○I○I web channel TOP"` | アプリケーション設定 | `"○I○I web channel TOP"` |  |
| `searchContent.naviTreeUrl` | ナビゲーションURL | ❌ 固定値 | `"http://voi.0101.co.jp/voi/"` | アプリケーション設定 | `"http://voi.0101.co.jp/voi/"` |  |
| `searchContent.colorDisplay` | カラー表示選択肢 | ❌ 固定値 | `["全色表示", "代表色"]` | アプリケーション設定 | `["全色表示", "代表色"]` |  |
| `searchContent.showPrice` | 価格表示フラグ | ❌ 固定値 | `true` | アプリケーション設定 | `true` |  |
| `searchContent.sortMenu` | ソート選択肢 | ❌ VAISC未対応 | `sortByList配列` | ❌ | ❌ | 未対応 |

### カラー商品詳細レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `colorProducts[].productId` | カラー別商品ID | `s_product_id` | `"WW5553671301_04"` | `product.variants[].id` | `"CF0210888001_01"` |  |
| `colorProducts[].colorId` | カラーID | `sm_color_id` | `"black"` | `product.variants[].attributes.color_id.text[0]` | `"white"` |  |
| `colorProducts[].colorName` | カラー名 | `sm_color_search` | `"ブラック"` | `product.variants[].colorInfo.colors[0]` | `"ホワイト"` |  |
| `colorProducts[].taxInclusivePrice` | カラー別価格 | `i_tax_inclusive_price` | `14850` | `product.variants[].priceInfo.price` | `7150` |  |
| `colorProducts[].oldPrice` | カラー別定価 | `i_old_price` | `0` | `product.variants[].priceInfo.originalPrice` | `7150` |  |
| `colorProducts[].discountRate` | カラー別割引率 | `i_discount_rate` | `0` | `product.variants[].attributes.discount_rate.numbers[0]` | `0` |  |
| `colorProducts[].flags` | カラー別フラグ | 各フラグフィールド | `{"rearrival": false, "newarrival": false}` | `product.variants[].attributes.flag_*.text[0]` | `{"rearrival": "false", "newarrival": "true"}` |  |
| `colorProducts[].detailUrl` | カラー別詳細URL | `url` | `"https://voi.0101.co.jp/..."` | ❌ VAISC未対応 | ❌ | 未対応 |
| `colorProducts[].imageURL` | カラー別画像URL | `s_thumb_img` | `"https://image.0101.co.jp/..."` | ❌ VAISC未対応 | ❌ | 未対応 |

## 📊 Menu APIレスポンスマッピング

### ファセット情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| ブランド一覧 + 件数 | ブランドファセット | `s_web_brand_code` | `{"code": "30095", "name": "アイテムズ...", "count": 23}` | `response.facets.brand_code.buckets[]` | `{"value": "adidas", "count": 1411}` |  |
| カテゴリ一覧 + 件数 | カテゴリファセット | `sm_primary_item` + `sm_secondary_item` | `{"code": 30162, "name": "ニット・セーター", "count": 47}` | `response.facets.category_code.buckets[]` | `{"value": "スニーカー", "count": 567}` |  |
| 価格帯一覧 + 件数 | 価格帯ファセット | `i_tax_inclusive_price` | `{"range": "3000-5000", "count": 15}` | `response.facets.price_range.buckets[]` | `{"value": "5000-10000", "count": 423}` |  |
| サイズ一覧 + 件数 | サイズファセット | `sm_size_id` + `sm_size_search` | `{"id": "90001", "name": "フリー", "count": 8}` | `response.facets.size_id.buckets[]` | `{"value": "M", "count": 234}` |  |
| カラー一覧 + 件数 | カラーファセット | `sm_color_id` + `sm_color_search` | `{"id": "brown", "name": "ブラウン", "count": 12}` | `response.facets.color_id.buckets[]` | `{"value": "ブラック", "count": 400}` |  |
| フラグ一覧 + 件数 | フラグファセット | 全フラグDBフィールド | `{"flag": "newarrival", "name": "新着", "count": 45}` | `response.facets.flags.buckets[]` | `{"value": "sale", "count": 234}` |  |

### 追加ファセット情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `gift.count` + `gift.isSelected` | ギフト対象商品数 | `i_icon_flag_giftwrap` | `{"count": 789, "isSelected": false}` | `response.facets.flag_giftwrap.buckets[]` | `{"value": "true", "count": 234}` |  |
| `coupon.count` + `coupon.isSelected` | クーポン対象商品数 | `i_icon_flag_coupon` | `{"count": 234, "isSelected": false}` | `response.facets.flag_coupon.buckets[]` | `{"value": "true", "count": 123}` |  |
| `used[]` | 新品/中古分類 | `i_icon_flag_used` | `[{"id": "0", "name": "新品", "count": 456}]` | `response.facets.flag_used.buckets[]` | `[{"value": "false", "count": 1200}]` |  |
| `price.bottom` + `price.top` | 価格範囲 | `i_tax_inclusive_price` | `{"bottom": 1000, "top": 50000}` | ❌ VAISC未対応 | ❌ | 未対応 |
| `saleOption[]` | セール選択肢 | 販売状態フラグ | `[{"id": "1", "name": "セール", "count": 123}]` | `response.facets.flags.buckets[]` | `[{"value": "sale", "count": 234}]` |  |
| `offrate[]` | 割引率選択肢 | `i_discount_rate` | `[{"id": "30", "name": "30%OFF以上", "count": 234}]` | `response.facets.discount_rate.buckets[]` | `[{"value": "30-100", "count": 156}]` |  |
| `arrivalOption[]` | 新着/再入荷選択肢 | 新着・再入荷フラグ | `[{"id": "1", "name": "新着", "count": 567}]` | `response.facets.flags.buckets[]` | `[{"value": "newarrival", "count": 345}]` |  |

### 検索コンテキスト情報レスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `freeword` | 検索クエリ | ❌ VAISC計算 | `"ナイキ　メンズ"` | `request.query` | `"adidas"` |  |
| `exword` | 除外キーワード | ❌ VAISC計算 | `"トート"` | `request.filter` (NOT条件) | `"トート"` |  |
| `title` | 検索結果タイトル | ❌ VAISC計算 | `"アウター・ジャケット"` | アプリケーションロジック | `"adidas"` |  |
| `fcdScdMap[]` | カテゴリマッピング | カテゴリマッピング | `[{"fcdId": "0001", "scdId": "30001"}]` | ❌ VAISC未対応 | ❌ | 未対応 |
| `popularKeywords[]` | 人気キーワード | 人気キーワード | `[{"param": "bcd", "value": {...}, "label": "ブランド"}]` | ❌ VAISC未対応 | ❌ | 未対応 |

### 特徴キーワードレスポンス

| 既存APIレスポンスフィールド | 論理名称 | DBフィールド | サンプルDBデータ | VAISCからの取得方法 | サンプルVAISCデータ | 備考 |
|---------------------------|---------|-------------|----------------|------------------|-------------------|------|
| `keyword[].groupId` + `keyword[].groupName` | キーワードグループ | キーワードグループ | `{"groupId": "G0001", "groupName": "素材・組成"}` | `response.facets.keyword_groups.buckets[]` | `{"value": "material", "displayName": "素材・組成"}` |  |
| `keyword[].keywordList[]` | 特徴キーワード | `sm_keywords_text` | `[{"keywordId": "A0166", "keywordName": "コットン・綿", "count": 345}]` | `response.facets.keywords.buckets[]` | `[{"value": "cotton", "count": 234}]` |  |

## 🔄 VAISCレスポンス変換ロジック

### VAISCカスタム属性からのデータ取得

```javascript
// ブール値変換（VAISC形式）
const isSale = product.attributes
  .find(attr => attr.key === "flag_sale")
  ?.value?.text?.[0] === "true";

// 数値変換（VAISC形式）
const discountRate = product.attributes
  .find(attr => attr.key === "discount_rate")
  ?.value?.numbers?.[0] || 0;

// 文字列取得（VAISC形式）
const brandNameEn = product.attributes
  .find(attr => attr.key === "brand_name_en")
  ?.value?.text?.[0] || "";
```

### VAISCネイティブ配列データの処理

```javascript
// VAISCネイティブ配列からカラー情報生成
const colorIds = product.attributes
  .find(attr => attr.key === "color_id")
  ?.value?.text || [];

const colorNames = product.colorInfo?.colors || [];

// カラー表示用オブジェクト生成（改良版）
const colorProducts = colorIds.map((id, index) => ({
    colorId: id,
    colorName: colorNames[index] || "",
    // VAISC構造により追加情報も容易に取得可能
    hexCode: product.attributes
      .find(attr => attr.key === "color_hex")
      ?.value?.text?.[index] || null
}));
```

### まとめ割メッセージ生成（VAISC数値型活用）

```javascript
// VAISC数値型による精密な処理
const bulkDiscountMessage = (() => {
    const minQty = product.attributes
      .find(attr => attr.key === "bulk_discount_min_qty")
      ?.value?.numbers?.[0];
    
    const rate = product.attributes
      .find(attr => attr.key === "bulk_discount_rate")
      ?.value?.numbers?.[0];
    
    if (minQty && rate) {
        return `${minQty}個以上で${rate}%OFF`;
    }
    return null;
})();
```

### VAISC標準レスポンス構造

```json
{
  "products": [
    {
      "id": "CF0212351201",
      "title": "ニットTシャツ",
      "uri": "https://voi.0101.co.jp/...",
      "priceInfo": {
        "currencyCode": "JPY",
        "price": 4990,
        "originalPrice": 5490
      },
      "brands": ["アイテムズ アーバンリサーチ"],
      "categories": ["ファッション", "レディース", "ニット・セーター"],
      "images": [
        {
          "uri": "https://image.0101.co.jp/...",
          "height": 400,
          "width": 300
        }
      ],
      "audience": {
        "genders": ["female"]
      },
      "colorInfo": {
        "colors": ["ブラウン", "ホワイト", "ブラック"]
      },
      "sizes": ["フリー", "M", "L"],
      "attributes": [
        {
          "key": "brand_code",
          "value": {"text": ["30095"]}
        },
        {
          "key": "discount_rate", 
          "value": {"numbers": [9]}
        },
        {
          "key": "flag_newarrival",
          "value": {"text": ["true"]}
        },
        {
          "key": "comment_count",
          "value": {"numbers": [2]}
        },
        {
          "key": "evaluation_average",
          "value": {"numbers": [4.5]}
        }
      ]
    }
  ],
  "totalProductCount": 847,
  "pagination": {
    "currentPage": 1,
    "pageSize": 20
  },
  "facets": {
    "brand_code": {
      "buckets": [
        {"value": "30095", "count": 23}
      ]
    },
    "price_range": {
      "buckets": [
        {"value": "3000-5000", "count": 15}
      ]
    }
  }
}
```

## 📊 全体互換性サマリー

### Search APIレスポンス互換性
- **商品基本情報**: 100% 対応（6/6項目）
- **ブランド情報**: 100% 対応（3/3項目）
- **価格情報**: 100% 対応（3/3項目）
- **ユーザー評価**: 100% 対応（3/3項目）
- **フラグ情報**: 93% 対応（13/14項目）- `flags.pricerereduced` 未対応
- **特別機能**: 50% 対応（1/2項目）- `couponThumbnail` 未対応
- **カラー表示**: 100% 対応（2/2項目）
- **ページング・メタ情報**: 100% 対応（3/3項目）
- **最上位レスポンス構造**: 83% 対応（5/6項目）- `sortMenu` 未対応
- **カラー商品詳細**: 78% 対応（7/9項目）- `detailUrl`, `imageURL` 未対応

### Menu APIレスポンス互換性
- **基本ファセット情報**: 100% 対応（6/6項目）
- **追加ファセット情報**: 86% 対応（6/7項目）- `price.bottom/top` 未対応
- **検索コンテキスト情報**: 60% 対応（3/5項目）- `fcdScdMap`, `popularKeywords` 未対応
- **特徴キーワード**: 100% 対応（2/2項目）

### 総合互換率
- **全体互換率**: **86% (65/76項目)**
- **Search API**: **88% (45/51項目)** 
- **Menu API**: **80% (20/25項目)**
- **未対応項目**: 11項目

#### 未対応項目一覧
**Search API**:
1. `flags.pricerereduced` - 再値下げフラグ
2. `couponThumbnail` - クーポンサムネイル
3. `sortMenu` - ソート選択肢
4. `colorProducts[].detailUrl` - カラー別詳細URL
5. `colorProducts[].imageURL` - カラー別画像URL

**Menu API**:
6. `price.bottom/top` - 価格範囲
7. `fcdScdMap` - カテゴリマッピング
8. `popularKeywords` - 人気キーワード

> **📌 注意**: 実際のVAISC APIでの動作確認による検証が必要です