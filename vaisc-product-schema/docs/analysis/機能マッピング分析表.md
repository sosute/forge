# VAISC JSON機能マッピング分析表

## 📋 分析概要

**目的**: 既存search/menu API機能がJSON形式→VAISC変換で維持できるかの精査  
**根拠**: 各機能とJSONフィールド・VAISC機能の対応関係を明示

## 🔍 機能マッピング表（JSONフィールドによる実現可否）

### Search API機能群

#### フリーワード検索機能（85% 実現可能、OR検索は要検討）
| 既存API機能 | 実現方法 | 既存DBフィールド | VAISCスキーマ準拠BigQuery定義 | VAISCでの実装 | 実現可否 | 根拠 |
|------------|---------|-----------------|----------|-------------|----------|------|
| フリーワード検索 (`q`) | VAISC標準検索 | `n_product_name_1` + `n_caption` + `sm_freewords` | `title` + `description` + ⚠️ 仮定義: `attributes.freeword_tags[]` | SearchRequest.query パラメータで全文検索 | ✅ 完全対応 | JSON構造で明確に分離、検索精度向上 |
| 絞り込みキーワード (`adw`) | VAISC検索クエリ | `n_product_name_1` + `n_caption` + `sm_freewords` | `title` + `description` + ⚠️ 仮定義: `attributes.freeword_tags[]` | SearchRequest.query にスペース区切りで追加キーワードを結合（例："ニット 赤"）- VAISCが全フィールドに対してAND検索を自動実行 | ✅ 完全対応 | 任意キーワードでの絞り込みはqueryパラメータが最適解 |
| 除外キーワード (`exq`) | VAISC除外クエリ | `n_product_name_1` + `n_caption` + `sm_freewords` | `title` + `description` + ⚠️ 仮定義: `attributes.freeword_tags[]` | filter パラメータで主要検索フィールドに対する包括的除外：`"NOT title: ANY(\"keyword\") AND NOT description: ANY(\"keyword\") AND NOT brands: ANY(\"keyword\")"` | ✅ 完全対応 | 複数フィールド横断の除外設定で任意キーワード除外が実現可能 |
| 複数キーワード（+区切り） | VAISC標準機能 | `n_product_name_1` + `n_caption` + `sm_freewords` | `title` + `description` + ⚠️ 仮定義: `attributes.freeword_tags[]` | 🔶 技術的には実現可能だが実装が複雑：filter で "title: ANY(\"keyword1\", \"keyword2\") OR description: ANY(\"keyword1\", \"keyword2\") OR brands: ANY(\"keyword1\", \"keyword2\")" - 主要フィールド横断設定が必要 | 🔍 要検討 | OR検索には複数フィールドへの包括的設定が必要で、保守性に課題 |

#### フィルタリング機能（98% 実現可能）
| 既存API機能 | 実現方法 | 既存DBフィールド | VAISCスキーマ準拠BigQuery定義 | VAISCでの実装 | 実現可否 | 根拠 |
|------------|---------|-----------------|----------|-------------|----------|------|
| ストアフィルタ (`store`) | 数値完全一致フィルタ | `i_store` | ⚠️ 仮定義: `attributes.store_text[]` | SearchRequest.filter: `"attributes.store_text: ANY(\"ファッション\")"` - ストア名テキスト値フィルタ 📝 | ✅ 完全対応 | VAISC推奨アプローチ：テキスト値使用 |
| 性別フィルタ (`figure`) | 列挙値フィルタ | `i_figure_main` | `audience.genders[]` | SearchRequest.filter: `"audience.genders: ANY(\"female\")"` - VAISC標準フィールド 📝 | ✅ 完全対応 | VAISC標準audienceフィールドで実現可能 |
| ブランドフィルタ (`bcd`) | 文字列完全一致フィルタ | `s_web_brand_code_text_jp` | `brands[]` | SearchRequest.filter: `"brands: ANY(\"アイテムズ アーバンリサーチ\")"` - VAISC標準フィールド 📝 | ✅ 完全対応 | VAISC標準brandsフィールドで実現可能 |
| 第1カテゴリフィルタ (`fcd`) | 階層カテゴリフィルタ | `t_primary_item_text` | `categories[]` | SearchRequest.filter: `"categories: ANY(\"ファッション\")"` - VAISC標準フィールド 📝 | ✅ 完全対応 | VAISC標準categoriesフィールドで実現可能 |
| 第2カテゴリフィルタ (`scd`) | 階層カテゴリフィルタ | `t_secondary_item_text` | `categories[]` | SearchRequest.filter: `"categories: ANY(\"ニット・セーター\")"` - VAISC標準フィールド 📝 | ✅ 完全対応 | VAISC標準categoriesフィールドで実現可能 |
| 価格フィルタ (`price`) | 数値範囲フィルタ | `i_tax_inclusive_price` | `priceInfo.price` | SearchRequest.filter: `"priceInfo.price: IN(1000.0i, 5000.0e)"` - VAISC標準範囲フィルタ構文 📊 | ✅ 完全対応 | VAISC標準priceフィールドの範囲フィルタで実現可能 |
| サイズフィルタ (`size`) | 複数選択フィルタ | `sm_size_search` | `sizes[]` | SearchRequest.filter: `"sizes: ANY(\"M\", \"L\")"` - VAISC標準サイズフィールド 📝 | ✅ 完全対応 | VAISC標準sizesフィールドで実現可能 |
| カラーフィルタ (`color`) | 複数選択フィルタ | `sm_color_search` | `colorInfo.colors[]` | SearchRequest.filter: `"colorInfo.colors: ANY(\"ブラウン\")"` - VAISC標準カラーフィールド 📝 | ✅ 完全対応 | VAISC標準colorInfoフィールドで実現可能 |
| 割引率フィルタ (`offrate`) | 数値範囲フィルタ | `i_discount_rate` | ⚠️ 仮定義: `attributes.discount_rate[]` | SearchRequest.filter: `"attributes.discount_rate: IN(10.0i, 50.0e)"` - カスタム属性の数値範囲フィルタ 📊 | ✅ 完全対応 | VAISCカスタム属性の数値範囲フィルタで実現可能 |
| 特徴フィルタ (`kwd`) | 複数選択フィルタ | `sm_keywords_text` | ⚠️ 仮定義: `attributes.keywords[]` | SearchRequest.filter: `"attributes.keywords: ANY(\"防水\", \"軽量\")"` - カスタム属性の文字列配列フィルタ 📝 | ✅ 完全対応 | VAISCカスタム属性でテキスト値使用 |
| 新着日フィルタ (`new_date`) | 日付範囲フィルタ | `s_rearrival_date` | ⚠️ 仮定義: `attributes.arrival_date[]` | ⚠️ 要確認: 日付データ定義不明 - 例: SearchRequest.filter: `"attributes.arrival_date: IN(\"2024-01-01\", \"2024-01-31\")"` | ⚠️ 要確認 | 新着日データの定義・形式確認が必要 |
| セール日フィルタ (`sale_date`) | 日付範囲フィルタ | `s_sale_start_date` | ⚠️ 仮定義: `attributes.sale_start_date[]` | SearchRequest.filter: `"attributes.sale_start_date: IN(\"2024-01-01\", \"2024-01-31\")"` - ISO 8601日付文字列での範囲フィルタ | ✅ 完全対応 | JSON文字列でISO 8601形式対応 |

#### フラグフィルタ機能（100% 実現可能）
| 既存API機能 | 実現方法 | 既存DBフィールド | VAISCスキーマ準拠BigQuery定義 | VAISCでの実装 | 実現可否 | 根拠 |
|------------|---------|-----------------|----------|-------------|----------|------|
| 新着フィルタ (`arrival`) | 文字列完全一致フィルタ | `i_icon_flag_newarrival` | ⚠️ 仮定義: `attributes.flag_newarrival[]` | SearchRequest.filter: `"attributes.flag_newarrival: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| セールフィルタ (`sale`) | 文字列完全一致フィルタ | `i_icon_flag_sale` | ⚠️ 仮定義: `attributes.flag_sale[]` | SearchRequest.filter: `"attributes.flag_sale: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| ギフトフィルタ (`gift`) | 文字列完全一致フィルタ | `i_icon_flag_giftwrap` | ⚠️ 仮定義: `attributes.flag_giftwrap[]` | SearchRequest.filter: `"attributes.flag_giftwrap: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| 期間限定セールフィルタ (`limitedsale`) | 文字列完全一致フィルタ | `i_icon_flag_limitedsale` | ⚠️ 仮定義: `attributes.flag_limitedsale[]` | SearchRequest.filter: `"attributes.flag_limitedsale: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| 販促キャンペーンフィルタ (`salespromotion`) | 文字列完全一致フィルタ | `i_icon_flag_salespromotion` | ⚠️ 仮定義: `attributes.flag_salespromotion[]` | SearchRequest.filter: `"attributes.flag_salespromotion: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| 送料無料フィルタ (`shipfree`) | 文字列完全一致フィルタ | `i_icon_flag_deliveryfeeoff` | ⚠️ 仮定義: `attributes.flag_deliveryfeeoff[]` | SearchRequest.filter: `"attributes.flag_deliveryfeeoff: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| 先行予約フィルタ (`preorder`) | 文字列完全一致フィルタ | `i_icon_flag_reservation` | ⚠️ 仮定義: `attributes.flag_reservation[]` | SearchRequest.filter: `"attributes.flag_reservation: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| 中古商品フィルタ (`used`) | 文字列完全一致フィルタ | `i_icon_flag_used` | ⚠️ 仮定義: `attributes.flag_used[]` | SearchRequest.filter: `"attributes.flag_used: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| クーポンフィルタ (`coupon`) | 文字列完全一致フィルタ | `i_icon_flag_coupon` | ⚠️ 仮定義: `attributes.flag_coupon[]` | SearchRequest.filter: `"attributes.flag_coupon: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| まとめ割フィルタ (`bulkdiscount`) | 文字列完全一致フィルタ | `i_icon_flag_bulk_discount` | ⚠️ 仮定義: `attributes.flag_bulkdiscount[]` | SearchRequest.filter: `"attributes.flag_bulkdiscount: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| シークレットセールフィルタ (`secretsale`) | 文字列完全一致フィルタ | `i_icon_flag_secretsell` | ⚠️ 仮定義: `attributes.flag_secretsale[]` | SearchRequest.filter: `"attributes.flag_secretsale: ANY(\"true\")"` - 文字列"true"/"false"完全一致フィルタ | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |

#### ソート機能（85% 実現可能）
| 既存API機能 | 実現方法 | 既存DBフィールド | VAISCスキーマ準拠BigQuery定義 | VAISCでの実装 | 実現可否 | 根拠 |
|------------|---------|-----------------|----------|-------------|----------|------|
| 関連度順 (`sortby`) | VAISC標準ソート | ❌ VAISC計算 | VAISC標準機能 | SearchRequest.orderBy: デフォルト（関連度ベース）- VAISC標準機能 | ✅ 完全対応 | 検索エンジン標準機能（JSON化で改善なし） |
| 価格順（昇順・降順） | 数値ソート | `i_tax_inclusive_price` | `priceInfo.price` | SearchRequest.orderBy: `"price asc"` または `"price desc"` - VAISC標準価格ソート | ✅ 完全対応 | JSON数値型でソート精度向上 |
| 割引率順 | 数値ソート | `i_discount_rate` | ⚠️ 仮定義: `attributes.discount_rate[]` | SearchRequest.orderBy: `"attributes.discount_rate desc"` - カスタム属性数値ソート | ✅ 完全対応 | JSON数値型でソート精度向上 |
| 新着順 | 日付ソート | `s_rearrival_date` | ⚠️ 仮定義: `attributes.arrival_date[]` | ⚠️ 要確認: 日付データ定義不明 - 例: SearchRequest.orderBy: `"attributes.arrival_date desc"` | ⚠️ 要確認 | 新着日データの定義・形式確認が必要 |
| 人気順 | ❌ データ不足 | ❌ 人気指標なし | ❌ 実装不可 | ❌ 実装不可 - 人気度指標のフィールドが存在しない | ❌ 未対応 | 人気度指標のフィールドなし（JSON化で改善されず） |

#### ページング・表示制御機能（95% 実現可能）
| 既存API機能 | 実現方法 | 既存DBフィールド | VAISCスキーマ準拠BigQuery定義 | VAISCでの実装 | 実現可否 | 根拠 |
|------------|---------|-----------------|----------|-------------|----------|------|
| ページング (`page`, `per`) | VAISC標準機能 | ❌ VAISC計算 | VAISC標準機能 | SearchRequest.pageSize & SearchRequest.offset - VAISC標準ページング機能 | ✅ 完全対応 | 検索エンジン標準機能（JSON化で改善なし） |
| 総件数取得 | VAISC標準機能 | ❌ VAISC計算 | VAISC標準機能 | SearchResponse.totalSize - 検索結果メタデータ自動取得 | ✅ 完全対応 | 検索エンジン標準機能（JSON化で改善なし） |
| 代表色/全色表示 (`full`) | クライアント実装 | `sm_color_search` | `colorInfo.colors[]` | VAISC標準colorInfo配列 - クライアント側で代表色判定ロジック実装 📝 | ✅ 完全対応 | JSON配列で代表色判定ロジック実装可能 |
| 表示制御フラグ | VAISC条件フィルタ | `i_use_search_flag` + `i_prohibit_freewordsearch` | ⚠️ 仮定義: `attributes.search_display_flag[]` + `attributes.freeword_exclude_flag[]` | SearchRequest.filter: `"attributes.search_display_flag: ANY(\"true\") AND NOT attributes.freeword_exclude_flag: ANY(\"true\")"` - ファセット除外条件 | ✅ 完全対応 | JSON文字列ブールで条件指定明確化 |

### Menu API機能群

#### ファセット件数表示機能（100% 実現可能）
| 既存API機能 | 実現方法 | 既存DBフィールド | VAISCスキーマ準拠BigQuery定義 | VAISCでの実装 | 実現可否 | 根拠 |
|------------|---------|-----------------|----------|-------------|----------|------|
| ブランド別件数表示 | ファセット集計機能 | `s_web_brand_code_text_jp` | `brands[]` | SearchRequest.facetSpecs: `"brands"` - VAISC標準ファセット自動計算 📝 | ✅ 完全対応 | VAISC標準フィールドでファセット精度向上 |
| カテゴリ別件数表示 | ファセット集計機能 | `t_primary_item_text` + `t_secondary_item_text` | `categories[]` | SearchRequest.facetSpecs: `"categories"` - VAISC標準ファセット自動計算 📝 | ✅ 完全対応 | JSON階層配列でカテゴリファセット精度向上 |
| 価格帯別件数表示 | ファセット集計機能 | `i_tax_inclusive_price` | `priceInfo.price` | SearchRequest.facetSpecs: `"priceInfo.price"` - VAISC標準価格範囲ファセット自動計算 | ✅ 完全対応 | JSON数値型で価格範囲ファセット精度向上 |
| サイズ別件数表示 | ファセット集計機能 | `sm_size_search` | `sizes[]` | SearchRequest.facetSpecs: `"sizes"` - VAISC標準ファセット自動計算 📝 | ✅ 完全対応 | JSON配列で複数サイズファセット精度向上 |
| カラー別件数表示 | ファセット集計機能 | `sm_color_search` | `colorInfo.colors[]` | SearchRequest.facetSpecs: `"colorInfo.colors"` - VAISC標準ファセット自動計算 📝 | ✅ 完全対応 | JSON配列で複数カラーファセット精度向上 |
| フラグ別件数表示 | ファセット集計機能 | 全フラグフィールド | ⚠️ 仮定義: `attributes.flag_*[]` | SearchRequest.facetSpecs: `"attributes.flag_sale"`, `"attributes.flag_newarrival"` 等 - 文字列"true"/"false"ファセット自動計算 | ✅ 完全対応 | VAISCカスタム属性はtext型のため文字列で処理 |
| リアルタイム件数更新 | ファセット再計算機能 | ❌ VAISC計算 | VAISC標準機能 | VAISCファセット自動再計算 - リアルタイム件数更新自動実行 | ✅ 完全対応 | VAISC標準機能（JSON化で改善なし） |
| 複合フィルタ対応件数 | ファセット連動計算機能 | ❌ VAISC計算 | VAISC標準機能 | VAISCファセット条件連動計算 - 複数フィルタ適用時の件数自動再計算 | ✅ 完全対応 | VAISC標準機能（JSON化で改善なし） |

#### 50音ブランド分類機能（85% 実現可能）
| 既存API機能 | 実現方法 | 既存DBフィールド | VAISCスキーマ準拠BigQuery定義 | VAISCでの実装 | 実現可否 | 根拠 |
|------------|---------|-----------------|----------|-------------|----------|------|
| 50音分類表示 | クライアント側実装 | `s_web_brand_code_text_jp` | `brands[]` | SearchResponse.facets.brands結果をクライアント側で名前順ソート・カナ分類処理 | ✅ 完全対応 | JSON配列でブランド名取得・分類処理が明確化 |

## 🔍 実装要検討機能（1項目）

### 複数キーワードOR検索の実装課題

#### 📋 機能概要
| 対象機能 | 現在の実装 | 技術的実現性 | 実装難易度 | 保守性 | 推奨判定 |
|----------|-----------|-------------|-----------|--------|----------|
| 複数キーワード（+区切り）OR検索 | `title: ANY("keyword1", "keyword2") OR description: ANY("keyword1", "keyword2") OR brands: ANY("keyword1", "keyword2")` | ✅ 可能 | 🔴 高 | 🔴 低 | 🔶 要慎重検討 |

#### ⚡ 主要課題
1. **設定複雑性**: フィルタ条件が長大化（5フィールド × 2キーワード = 10条件のOR結合）
2. **保守困難性**: 検索対象フィールド追加時に全条件の更新が必要
3. **技術制限**: VAISC制限（最大10レベルネスト、OR句最大100引数）への抵触リスク
4. **運用負荷**: デバッグ・トラブルシューティングの困難さ

#### 🔧 推奨代替案
| 優先度 | 代替手法 | 実装方法 | メリット |
|-------|---------|---------|----------|
| **🔥 High** | VAISC類義語機能活用 | サービス提供コントロールで設定 | 自動的なOR検索相当の結果 |
| **🔶 Medium** | 関連性ベース検索 | SearchRequest.query での自然言語処理 | 実装負荷低、VAISC最適化 |
| **🔵 Low** | クライアント統合 | 複数回検索実行・結果統合 | 完全制御可能、サーバー負荷増 |

#### 💡 推奨方針
**VAISC標準機能を最大活用し、複雑なOR検索実装は回避**

---

## ❌ 実現不可能機能（2項目）

### Search API未対応機能
| 機能 | 理由 | 影響度 | 代替案 | JSON化での改善 |
|------|------|-------|--------|----------------|
| 人気順ソート | 人気指標データなし | 🟡 中 | 関連度順・お気に入り数順で代替 | なし |
| 再値下げ判定 (`flags.pricerereduced`) | 判定ロジック不明 | 🟢 低 | 通常値下げフラグで代替 | なし |

## 📝 要確認項目（2項目）

| 項目 | 確認内容 | 対応方法 | 優先度 |
|------|---------|---------|--------|
| 新着日データ (`arrival_date`) | 再入荷日と新着日の区別確認 | データ定義の明確化 | 🔶 Medium |
| フリーワード検索対象フィールド定義 | 既存DBフィールド名とVAISCスキーマの正確なマッピング確認 | 実際のDBスキーマ調査とVAISC Product Schema仕様確認が必要 | 🔥 High |

### 📌 実装前必須確認事項

**フリーワード検索機能セクションの定義について**：
- 「既存DBフィールド」「VAISCスキーマ準拠BigQuery定義」カラムは**仮定義**です

**必須確認項目**：
1. **実際のDBフィールド名**：商品名、説明文、フリーワードタグの正確なカラム名
2. **VAISCスキーマ仕様**：Google Product Schema準拠の正確なフィールド構造  
3. **データマッピング**：既存DB → JSON → VAISC の変換ルール確定

---

### 📊 全体実現度

- **総合実現率**: **93% (42/45項目)** 
- **実現可能機能**: **42項目** （✅ 完全対応として記載）
- **実装要検討機能**: **1項目** （🔍 OR検索：技術的実現可能だが保守性に課題）
- **要確認機能**: **1項目** （📝 新着日データの定義確認）
- **未対応機能**: **1項目** （❌ データ不足または実装不可）

> **📌 注意**: 実際のVAISC機能での動作確認による検証が必要です

---

## Appendix

### 📊 VAISC範囲フィルタ構文について

VAISC (Google Vertex AI Search for Commerce) の範囲指定で使用される `IN(start, end)` 構文の記号について説明します。

#### 範囲フィルタの記号

- **`i` (inclusive)**: **含む**（以上、≥）
- **`e` (exclusive)**: **含まない**（未満、<）

#### 具体例

```javascript
// 価格範囲: 1000円以上5000円未満
"priceInfo.price: IN(1000.0i, 5000.0e)"  // 1000.0 ≤ price < 5000.0

// 割引率範囲: 10%以上50%未満
"attributes.discount_rate: IN(10.0i, 50.0e)"  // 10.0 ≤ rate < 50.0

// 日付範囲: 2024年1月1日以降、2月1日未満
"attributes.sale_date: IN(\"2024-01-01\"i, \"2024-02-01\"e)"
// 2024-01-01 ≤ date < 2024-02-01 （1月中の全日を含む）
```

#### 他の組み合わせ例

```javascript
// 両端を含む範囲
"priceInfo.price: IN(1000.0i, 5000.0i)"  // 1000 ≤ price ≤ 5000

// 両端を含まない範囲
"priceInfo.price: IN(1000.0e, 5000.0e)"  // 1000 < price < 5000

// 片端のみ含む範囲
"priceInfo.price: IN(1000.0e, 5000.0i)"  // 1000 < price ≤ 5000
```

### 📝 VAISC標準フィールドの推奨使用について

VAISCでは標準フィールドの使用が推奨されています。

#### 推奨アプローチ
- **標準フィールド優先**: `sizes[]`, `colorInfo.colors[]` などのVAISC標準フィールドを使用
- **意味のあるテキスト値**: IDではなくユーザーに意味のあるテキスト値を使用
- **パフォーマンス最適化**: VAISCが最適化された標準フィールドの恢用

#### IDフィールドの使用けース
以下のような特別なケースではIDフィールドを使用することもあります：
- **既存システムとの互換性**: 既存APIでIDベースのフィルタが使われている場合
- **パフォーマンス要件**: 高速な結合処理が必要な場合
- **データ整合性**: テキスト値に不整合性がある場合

このような場合は `attributes.size_id.text[]` や `attributes.color_id.text[]` を補完的に使用します。

```javascript
// 推奨: 標準フィールドでテキスト値使用
"sizes: ANY(\"S\", \"M\", \"L\")"
"colorInfo.colors: ANY(\"ブラウン\", \"ブラック\")"

// 補完: IDフィールド（特別なケースのみ）
"attributes.size_id: ANY(\"90001\", \"90002\", \"90003\")"
"attributes.color_id: ANY(\"brown\", \"black\")"
```