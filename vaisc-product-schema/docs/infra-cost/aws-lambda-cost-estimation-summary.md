# AWS Lambda プロキシAPI コスト試算サマリ

## インフラ部門連携用回答

### 質問事項への回答

## API Gateway

### ピーク時リクエスト数
- **通常時**: 7.3 RPS（月平均33.7万/日）
- **セール日**: 29.2 RPS（月平均134.7万/日）
- **瞬間スパイク**: **584 RPS**（セール開始10-30分間、平時の20倍）

### APIタイプ
- **推奨**: HTTP API（コスト重視、REST APIより約70%安価）

### データ送信量
- **1リクエスト当たり**: 112KB（加重平均）
  - **計算根拠**: 既存API実測値をVAISC統合スキーマに変換
  - 60商品:186KB（30%）、30商品:98KB（50%）、10商品:39KB（20%）
- **月間データ転送量**: 1.15TB

### キャッシュ機能
- **利用**: しない（フリーワード検索の特性上効果が期待できないため）

## Lambda

### アーキテクチャ
- **推奨**: Arm (Graviton2)（x86より約20%安価）
- **理由**: I/Oバウンド処理のため最適、コスト効率良好

### ピーク時リクエスト数
- **API Gatewayと同数**: 584 RPS（瞬間スパイク時）

### 実行時間・メモリサイズ
- **メモリ**: 512MB（初期想定値）
- **実行時間**: 150ms（想定値）
- **必要同時実行数**: 90（スパイク時）

## 月間コスト概算

### 推奨構成（部分プロビジョニング）
**月間コスト**: **$212**（年間$2,544）

**内訳**:
- API Gateway: $108.73
- Lambda実行: $12.26
- プロビジョニング30同時実行: $91.28

### 全構成比較

| 構成 | 月間コスト | 年間コスト | 特徴 |
|------|-----------|-----------|------|
| 標準構成 | $121 | $1,452 | コールドスタートリスクあり |
| **部分プロビジョニング（推奨）** | **$212** | **$2,544** | **セール安定、コストバランス良好** |
| フルプロビジョニング | $395 | $4,740 | 最高性能、高コスト |
| 予約済み同時実行 | $196 | $2,352 | コスト効率重視 |

## その他のAWSサービス料金

### AWS Secrets Manager
- **月間コスト**: $2（無視できる範囲）
- **用途**: API認証情報、接続文字列などの機密情報管理

## 重要確認事項

### 1. インフラ制限対応
- **Lambda制限緩和**: デフォルト1,000同時実行制限（現在90必要）
- **API Gateway制限**: 10,000 RPS上限確認
- **アカウント制限**: 制限緩和申請が必要な可能性

### 2. 事前検証必要事項
- **負荷テスト**: 600 RPS での性能検証必須
- **バックエンド対応**: 検索エンジン・DB側の584 RPS対応可否確認
- **ネットワーク帯域**: VPC使用時のNAT Gateway制限確認

### 3. セール対策
- **事前準備**: セール開始30分前からのスケールアップ
- **監視体制**: リアルタイム監視、自動アラート設定
- **障害時対策**: Graceful Degradation、キャッシュフォールバック

## データ転送量計算根拠

### 既存API実測値
```
1. menu API: 52KB
2. search API: 250KB (60商品)
   → 1商品あたり: 4.2KB
```

### VAISC統合による最適化
```
統合効果: 30%削減（0.7倍）
- API統合による重複データ排除
- 不要フィールドの除外
- 効率的なJSON構造
```

### 最終計算
```
検索結果パターン別レスポンスサイズ:
- 60商品: 4.2KB × 60 × 0.7 + 10KB = 186KB (30%)
- 30商品: 4.2KB × 30 × 0.7 + 10KB = 98KB (50%)  
- 10商品: 4.2KB × 10 × 0.7 + 10KB = 39KB (20%)

加重平均: 112KB/リクエスト
月間転送量: 10,237,183 × 112KB = 1.15TB
```

## 推奨事項

### 1. 構成選択
- **推奨**: 部分プロビジョニング構成（月$212）
- **理由**: セール時安定性とコストのバランスが最適

### 2. 段階的導入
- **Phase 1**: 標準構成で開始（月$121）
- **Phase 2**: セール前に部分プロビジョニング導入
- **Phase 3**: 負荷状況に応じて最適化

### 3. 監視・運用
- **CloudWatch**: RPS、エラー率、レスポンス時間の監視
- **自動スケーリング**: セール時の段階的スケールアップ
- **性能最適化**: Lambda実行時間・メモリサイズの継続的最適化