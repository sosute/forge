# AWS Lambda プロキシAPI ランニングコスト試算

## 前提条件

### 対象サービス
- **用途**: アパレル商品ECのフリーワード検索
- **特徴**: セールスタート時の瞬間的なアクセススパイクあり

### 過去の検索回数データ（フリーワード検索のみ）

| 年月 | フリーワード検索回数 |
|------|-------------------|
| 2024/01 | 11,549,408 |
| 2024/02 | 10,093,610 |
| 2024/03 | 12,476,013 |
| 2024/04 | 9,417,656 |
| 2024/05 | 10,623,188 |
| 2024/06 | 9,566,968 |
| 2024/07 | 9,195,526 |
| 2024/08 | 8,973,349 |
| 2024/09 | 10,584,883 |
| 2024/10 | 8,999,503 |
| 2024/11 | 11,813,821 |
| 2024/12 | 9,552,273 |
| **合計** | **122,846,198** |

## アクセスパターン分析

### 基本統計

#### 月間リクエスト数
```
平均: 122,846,198 ÷ 12 = 10,237,183リクエスト/月
最大: 12,476,013リクエスト/月（2024年3月）
最小: 8,973,349リクエスト/月（2024年8月）
```

#### 日次平均リクエスト数
```
月間平均: 10,237,183 ÷ 30.4日 = 336,684リクエスト/日
最大月ベース: 12,476,013 ÷ 31日 = 402,452リクエスト/日
```

### アパレルEC向けピーク時計算ロジック

#### 係数設定根拠
- **一般ECサイト**: 平常時の1.5-2.0倍
- **アパレルECセール時**: 平常時の3.0-5.0倍
- **瞬間スパイク**: セール開始直後の10-30分間で**平時の20倍**

#### ピーク時推定計算

##### 1. 平時のベースライン算出
```
月間平均日次: 336,684リクエスト/日
営業時間集中率: 70%が9-18時（9時間）に集中
平時営業時間RPS: 336,684 × 0.7 ÷ 9 ÷ 3600 = 7.3リクエスト/秒
```

##### 2. 日次ピーク（セール日）
```
基準: 月間平均日次 = 336,684リクエスト/日
セール日係数: × 4.0（アパレルECの一般的なセール効果）
日次ピーク = 336,684 × 4.0 = 1,346,736リクエスト/日
```

##### 3. セール日の平時RPS
```
セール日営業時間RPS: 7.3 × 4.0 = 29.2リクエスト/秒
```

##### 4. 瞬間スパイク（セール開始直後10-30分間）
```
瞬間スパイク係数: × 20倍（平時に対して）
瞬間ピークRPS = 29.2 × 20 = 584リクエスト/秒
瞬間ピーク時間当たり = 584 × 3600 = 2,102,400リクエスト/時間
```

### 設計用ピーク値

| 項目 | 通常時 | セール日平時 | セール開始時スパイク |
|------|--------|-------------|-------------------|
| 日次リクエスト | 33.7万 | 134.7万 | - |
| 時間リクエスト | 1.9万 | 7.5万 | 210.2万 |
| 15分間リクエスト | 4,700 | 18,800 | 525,600 |
| 秒間リクエスト（RPS） | 7.3 | 29.2 | **584** |
| 必要同時実行数 | 2 | 5 | **90** |

## データ転送量の実測ベース計算詳細

### 既存APIレスポンスサイズ実測
```
実測URL分析:
1. menu API: https://marui.search.zetacx.net/api/menu?factor=freeword&q=adidas&full=0
   → レスポンスサイズ: 52,305 bytes (約52KB)
   
2. search API: https://marui.search.zetacx.net/api/search?factor=freeword&q=adidas&full=0
   → レスポンスサイズ: 約250KB (60商品含む)
   → 1商品あたり: 250KB ÷ 60 = 約4.2KB/商品

注: 実測URLは代表色表示クエリのため、全色表示よりもレスポンスサイズが大きくなる傾向があります。
    これにより試算は上振れ方向のバッファを確保した安全側の見積もりとなっています。
```

### VAISC統合APIによるレスポンスサイズ最適化
```
既存API → VAISC統合APIの変換による効果:

1. API統合によるサイズ削減要因:
   - search + menu の2回呼び出し → 1回の統合レスポンス
   - 重複データの排除（ブランド名、カテゴリ名等）
   - 不要フィールドの除外（内部ID、管理フラグ等）
   
2. スキーマ最適化:
   - 効率的なJSON構造（冗長性削減）
   - ファセット情報の集約
   - 商品情報の正規化
   
3. 推定削減率: 約0.7倍（30%削減）
```

### レスポンスサイズ計算（改訂版）
```
VAISC統合APIのレスポンスサイズ:
- 商品リスト + ファセット情報（60商品最大）: 4.2KB × 60 × 0.7 + ファセット10KB = 186KB
- 商品リスト + ファセット情報（30商品平均）: 4.2KB × 30 × 0.7 + ファセット10KB = 98KB
- 商品リスト + ファセット情報（10商品少数）: 4.2KB × 10 × 0.7 + ファセット10KB = 39KB

利用パターン（想定）:
- 60商品（人気ブランド・カテゴリ検索）: 30%
- 30商品（一般的な検索）: 50%
- 10商品（ニッチな検索）: 20%

平均レスポンスサイズ:
186KB × 0.3 + 98KB × 0.5 + 39KB × 0.2 = 112KB/リクエスト
```

### 月間データ転送量計算
```
月間リクエスト数: 10,237,183
平均レスポンスサイズ: 112KB（VAISC統合API、加重平均）
月間データ転送量: 10,237,183 × 112KB = 1,146,564,496KB ≈ 1.15TB
```

## AWS構成とコスト試算

### API Gateway（HTTP API）

#### 設定パラメータ
```
APIタイプ: HTTP API（REST APIより約70%安価）
月間リクエスト数: 10,237,183（平均）
ピークRPS: 584（セール開始時スパイク）
データ転送量: 約1.15TB/月（112KB/レスポンス加重平均）
キャッシュ: 利用しない（フリーワード検索の特性上効果が期待できないため）
スロットリング制限: 600 RPS（安全マージン）
```

#### 料金計算（東京リージョン）
```
リクエスト料金:
- 最初の300万リクエスト: $0.90/百万 × 3 = $2.70
- 残り700万リクエスト: $0.35/百万 × 7.24 = $2.53
- 合計: $5.23/月

データ転送料金:
- 1,150GB × $0.09/GB = $103.50/月

月間合計: $108.73
```

### Lambda

#### 設定パラメータ
```
アーキテクチャ: Arm (Graviton2)
メモリサイズ: 512MB
実行時間: 150ms（想定）
月間実行回数: 10,237,183
同時実行数（スパイク時）: 90
同時実行数（セール日平時）: 5
同時実行数（通常時）: 2
```

#### 料金計算
```
実行回数課金:
- 10,237,183回 × $0.0000002 = $2.05/月

実行時間課金:
- GB秒: 10,237,183 × 0.5GB × 0.15秒 = 767,789 GB秒
- 料金: 767,789 × $0.0000133 = $10.21/月

月間合計: $12.26
```

### 同時実行数対応

#### プロビジョニング済み同時実行の検討

##### パターンA: フルプロビジョニング（高コスト・高性能）
```
設定値: 90同時実行（スパイク対応）
料金: 90 × $0.000004167 × 730時間 = $273.80/月
リクエスト料金: 通常のLambda実行料金から差し引き
```

##### パターンB: 部分プロビジョニング（推奨）
```
設定値: 30同時実行（セール日平時の6倍）
料金: 30 × $0.000004167 × 730時間 = $91.28/月
スパイク時: オンデマンド実行でカバー（コールドスタートあり）
```

##### パターンC: 予約済み同時実行（コスト重視）
```
設定値: 100同時実行の予約
割引率: 約40%
料金: 約$80/月（想定）
メリット: 大幅コスト削減、一定の性能保証
```

## 総コスト概算

### パターン1: 標準構成（オンデマンドのみ）
```
API Gateway: $108.73/月
Lambda実行: $12.26/月
データ転送: 上記に含む
合計: $120.99/月

リスク: セール時のコールドスタート、レスポンス遅延
```

### パターン2: 部分プロビジョニング構成（推奨）
```
API Gateway: $108.73/月
Lambda実行: $12.26/月
プロビジョニング: $91.28/月（30同時実行）
合計: $212.27/月

メリット: セール日安定、スパイク時は一部コールドスタート
```

### パターン3: フルプロビジョニング構成（高性能）
```
API Gateway: $108.73/月
Lambda実行: $12.26/月
プロビジョニング: $273.80/月（90同時実行）
合計: $394.79/月

メリット: 完全なコールドスタート排除、最高の安定性
```

### パターン4: 予約済み同時実行（コスト重視）
```
API Gateway: $108.73/月
Lambda実行: $12.26/月 × 0.6 = $7.36/月（40%割引）
予約料金: 約$80/月（想定）
合計: $196.09/月

メリット: コスト効率良好、予測可能な料金
```

## 最適化提案

### 1. Lambda最適化
```
メモリサイズ調整:
- 現在想定: 512MB
- 最適化後: 256MB or 1024MB（処理内容により）
- 効果: 10-20%コスト削減
```

### 2. セール対応
```
Auto Scaling設定:
- 通常時: 2-5同時実行
- セール準備: 30分前から30同時実行に増加
- セール開始: 90同時実行（オンデマンド併用）
- セール終了: 段階的に削減

CloudWatch監視:
- RPS閾値アラート: 500 RPS（スパイク予兆検知）
- エラー率アラート: 1%
- レスポンス時間アラート: 500ms
- 同時実行数アラート: 80実行（制限接近警告）
- スロットリング監視: API Gateway 580 RPS超過
```

## 運用コスト予測

| シナリオ | 月間コスト | 年間コスト | 主な特徴 |
|----------|------------|------------|----------|
| 標準構成 | $121 | $1,452 | コールドスタートあり、スパイク時リスク |
| 部分プロビジョニング（推奨） | $212 | $2,544 | セール安定、コストバランス良好 |
| フルプロビジョニング | $395 | $4,740 | 最高性能、高コスト |
| 予約済み同時実行 | $196 | $2,352 | コスト効率重視、予測可能 |

## その他のAWSサービス料金

### AWS Secrets Manager
```
用途: API認証情報、接続文字列などの機密情報管理
料金体系:
- シークレット保管: $0.40/月/シークレット
- API呼び出し: $0.05/10,000回

想定使用量:
- 保管シークレット数: 5個（各API認証情報等）
- API呼び出し回数: Lambda実行時のキャッシュにより最小化
  （コンテナ再利用により実質1,000回/月程度）

月間コスト:
- 保管料金: 5 × $0.40 = $2.00/月
- API呼び出し: 1,000回 × $0.05/10,000 = $0.01/月
- 合計: $2.01/月（無視できる範囲）
```

## 注意事項

1. **瞬間スパイク（584 RPS）対応**
   - **Lambda制限**: デフォルト1,000同時実行制限の確認必要
   - **アカウント制限**: 制限緩和申請が必要な可能性
   - **バックエンド依存関係**: 検索エンジン・DBのRPS制限確認
   - **ネットワーク帯域**: VPC使用時のNAT Gateway制限

2. **実測値による調整が必要**
   - 実際の処理時間とメモリ使用量
   - セール時の実際のアクセス増加率（20倍想定の検証）
   - 瞬間スパイク持続時間（10-30分想定の確認）

3. **高負荷対応の追加考慮事項**
   - **API Gateway制限**: 10,000 RPS上限（リージョン制限）
   - **CloudWatch Logs**: 大量ログ出力時の追加料金
   - **X-Ray トレーシング**: 高RPS時の料金影響
   - **バックエンド接続**: 接続プール、タイムアウト設定の最適化

4. **セール対策（高負荷対応）**
   - **事前負荷テスト**: 600 RPS での性能検証必須
   - **段階的制御**: Circuit Breaker、Rate Limiting実装
   - **障害時対策**: Graceful Degradation、キャッシュフォールバック
   - **監視体制**: リアルタイム監視、自動アラート設定
   - **運用計画**: セール開始前30分の準備体制、終了後の段階的縮退